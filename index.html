<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAradhya Pharma Order App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #0f172a; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        
        /* Status Bar */
        #status { background: #fff3cd; color: #856404; padding: 15px; text-align: center; font-size: 0.95rem; margin-bottom: 10px; border-radius: 6px; display: none; }
        #status.success { background: #dcfce7; color: #166534; }
        #status.error { background: #fee2e2; color: #991b1b; }

        /* Manual Input Fallback */
        #manualInput { display: none; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px; text-align: center; }
        #manualInput textarea { width: 100%; height: 100px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }

        /* Controls */
        .controls { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 15px; display: grid; gap: 10px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }

        /* Product List */
        .product-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); content-visibility: auto; contain-intrinsic-size: 100px; }
        .p-info h3 { margin: 0 0 5px 0; font-size: 1rem; color: #1e293b; }
        .p-meta { font-size: 0.85rem; color: #64748b; }
        .p-price { font-weight: bold; color: var(--primary); margin-top: 5px; }
        
        /* Qty Controls */
        .qty-box { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 20px; }
        .q-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; color: var(--primary); font-size: 1.2rem; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .q-btn:active { transform: scale(0.95); }
        .q-val { font-weight: 600; min-width: 24px; text-align: center; }

        /* Cart Footer */
        .cart-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.25); z-index: 999; display: none; cursor: pointer; }
        .cart-btn { background: #10b981; border: none; padding: 8px 20px; border-radius: 20px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem; }

        /* Order Modal */
        #orderModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; display: none; }
        .invoice { max-width: 800px; margin: auto; padding: 20px; background: white; min-height: 100vh; }
        
        /* Customer Form */
        .cust-form { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: grid; gap: 10px; }
        .cust-form input { border: 1px solid #cbd5e1; }
        
        /* Invoice Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 20px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .text-right { text-align: right; }
        
        /* Summary Block */
        .summary-block { width: 100%; max-width: 300px; margin-left: auto; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; page-break-inside: avoid; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .summary-row.total { border-top: 2px solid #cbd5e1; padding-top: 8px; font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        
        /* Footer Message */
        .legal-footer { margin-top: 30px; text-align: center; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-top: 1px solid #e2e8f0; padding-top: 15px; }

        /* Buttons */
        .action-bar { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn-lg { padding: 12px 24px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; flex: 1; max-width: 200px; }
        
        /* --- PRINT SETTINGS --- */
        @media print { 
            body * { visibility: hidden; } /* Hide everything */
            #orderModal, #orderModal * { visibility: visible; } /* Show only modal */
            #orderModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; display: block !important; overflow: visible; background: white; }
            .no-print { display: none !important; }
            .invoice { padding: 0; border: none; width: 100%; max-width: 100%; margin: 0; }
            .container, header, .cart-bar { display: none; }
            thead { display: table-header-group; } 
            tfoot { display: none; } 
            tr { page-break-inside: avoid; }
            .summary-block { break-inside: avoid; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <h3>üíä AAradhya Order App</h3>
</header>

<div class="container" id="mainApp">
    <div id="status">Connecting...</div>
    
    <div id="manualInput">
        <h3>‚ö†Ô∏è Automatic Loading Failed</h3>
        <p>Your network is blocking the direct connection. Please follow these steps:</p>
        <ol style="text-align:left; max-width:300px; margin:auto;">
            <li><a href="#" id="sheetLink" target="_blank">Click here to open data</a></li>
            <li>Select All (Ctrl+A) and Copy (Ctrl+C) the text.</li>
            <li>Paste it in the box below and click "Load".</li>
        </ol>
        <textarea id="pasteBox" placeholder="Paste data here..."></textarea>
        <br>
        <button class="btn-lg" style="background:var(--primary); margin-top:10px;" onclick="loadManualData()">Load Data</button>
    </div>

    <div class="controls no-print" id="appControls" style="display:none;">
        <input type="text" id="search" placeholder="üîç Search medicine..." onkeyup="filterItems()">
        <select id="compSelect" onchange="filterItems()">
            <option value="ALL">Loading Companies...</option>
        </select>
    </div>

    <div id="list"></div>
</div>

<div id="cartBar" class="cart-bar no-print" onclick="openOrder()">
    <div>
        <span style="font-size:0.8rem; opacity:0.8">Items: <span id="cartCount">0</span></span><br>
        <b style="font-size:1.1rem">‚Çπ<span id="cTotal">0.00</span></b>
    </div>
    <button class="cart-btn">View Order</button>
</div>

<div id="orderModal">
    <div class="invoice">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--primary);">Order Summary</h2>
            <button onclick="document.getElementById('orderModal').style.display='none'" class="no-print" style="font-size:2rem; background:none; border:none; cursor:pointer; color:#64748b;">&times;</button>
        </div>

        <div class="cust-form no-print">
            <h4 style="margin:0 0 5px 0;">Customer Details</h4>
            <input type="text" id="cName" placeholder="Enter Name *" required>
            <input type="number" id="cMobile" placeholder="Enter Mobile Number *" required>
        </div>

        <div id="printInfo">
            <p><strong>Name:</strong> <span id="dispName" style="color:#64748b;">(Not Entered)</span></p>
            <p><strong>Mobile:</strong> <span id="dispMobile" style="color:#64748b;">(Not Entered)</span></p>
            <p><strong>Date:</strong> <span id="oDate"></span></p>
        </div>

        <table>
            <thead><tr><th>Item</th><th class="text-right">Qty</th><th class="text-right">Value</th></tr></thead>
            <tbody id="oBody"></tbody>
        </table>

        <div class="summary-block">
            <div class="summary-row">
                <span>Subtotal:</span>
                <span>‚Çπ<span id="subTotal">0.00</span></span>
            </div>
            <div class="summary-row">
                <span>GST (5%):</span>
                <span>‚Çπ<span id="gstVal">0.00</span></span>
            </div>
            <div class="summary-row total">
                <span>Grand Total:</span>
                <span>‚Çπ<span id="grandTotal">0.00</span></span>
            </div>
        </div>

        <div class="legal-footer">
            This order form is designed for AAradhya Pharmaceuticals by AAradhya Pharmaceuticals to be used by staff and customers of AAradhya Pharmaceuticals.
        </div>

        <div class="action-bar no-print">
            <button class="btn-lg" style="background:#2563eb;" onclick="printOrder()">üñ®Ô∏è Print / PDF</button>
            <button class="btn-lg" style="background:#25D366;" onclick="shareWA()">üì± WhatsApp</button>
        </div>
    </div>
</div>

<script>
    // --- SETTINGS ---
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQWE4gE40MJrObusTZARsQ3mOkyQAK-djFktAEL0zgnj5sawV0hMeCgRhoDHX3JA/pub?output=csv";
    document.getElementById('sheetLink').href = SHEET_URL;
    const CACHE_KEY = "aaradhya_stock_data";
    const CACHE_TIME_KEY = "aaradhya_stock_time";
    const CACHE_DURATION = 60 * 60 * 1000; // 1 hour

    const PROXIES = [
        "https://corsproxy.io/?",
        "https://api.allorigins.win/raw?url=", 
        "https://api.codetabs.com/v1/proxy?quest="
    ];

    let db = []; // Array for filtering
    let dbMap = new Map(); // Map for O(1) lookups
    let cart = {};

    function log(msg, type="info") {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.className = type;
        el.style.display = 'block';
    }

    // --- 1. OPTIMIZED DATA LOADING ---
    async function init() {
        // Try Cache First
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
        const now = new Date().getTime();

        if (cachedData && cachedTime && (now - cachedTime < CACHE_DURATION)) {
            log("‚ö° Loading from cache...", "success");
            processData(cachedData, false); // false = don't save again
            // Fetch fresh data in background to update cache for next time
            fetchData(true);
            return;
        }

        fetchData();
    }

    async function fetchData(background = false) {
        if(!background) log("‚è≥ Connecting to database...");
        
        let csvText = null;
        for (let i = 0; i < PROXIES.length; i++) {
            try {
                const proxy = PROXIES[i];
                const res = await fetch(proxy + encodeURIComponent(SHEET_URL));
                if (res.ok) {
                    const text = await res.text();
                    if(text.includes("company") || text.includes("item")) {
                        csvText = text;
                        break;
                    }
                }
            } catch (e) { console.warn("Proxy failed:", PROXIES[i]); }
        }

        if (csvText) {
            processData(csvText, true);
        } else if (!background) {
            log("‚ùå Network blocked. Use manual load.", "error");
            document.getElementById('manualInput').style.display = 'block';
        }
    }

    function loadManualData() {
        const text = document.getElementById('pasteBox').value;
        if(text.length < 50) return alert("Please paste the data first.");
        processData(text, true);
        document.getElementById('manualInput').style.display = 'none';
    }

    function processData(csvData, saveCache = false) {
        if(saveCache) {
            try {
                localStorage.setItem(CACHE_KEY, csvData);
                localStorage.setItem(CACHE_TIME_KEY, new Date().getTime());
            } catch(e) { console.warn("Cache full"); }
        }

        // Use Worker for non-blocking parsing
        Papa.parse(csvData, {
            header: true, 
            skipEmptyLines: true,
            worker: true, // Run in background thread
            complete: function(results) {
                const uniqueMap = new Map();
                
                // Optimized processing loop
                const data = results.data;
                const len = data.length;
                
                // Detect keys once
                if(len > 0) {
                    const keys = Object.keys(data[0]);
                    const kName = keys.find(k => k.toLowerCase().includes("item") || k.toLowerCase().includes("name"));
                    const kComp = keys.find(k => k.toLowerCase().includes("company"));
                    const kRate = keys.find(k => k.toLowerCase().includes("rate"));
                    const kStock = keys.find(k => k.toLowerCase().includes("stock"));

                    for(let i = 0; i < len; i++) {
                        const row = data[i];
                        const name = row[kName];
                        const rate = parseFloat((row[kRate] || "0").replace(/[^\d.]/g,''));
                        
                        if (name && rate > 0) {
                            const comp = row[kComp] || "General";
                            const stock = (row[kStock] || "").toString();
                            const id = name + "|" + comp;
                            
                            // Use map for deduplication
                            if (!uniqueMap.has(id)) {
                                uniqueMap.set(id, { id, name, company: comp, rate, stock });
                            }
                        }
                    }
                }

                db = Array.from(uniqueMap.values());
                dbMap = uniqueMap; // Save map for O(1) access

                if(db.length === 0) {
                     log("‚ùå Loaded data is empty.", "error");
                     return;
                }

                log(`‚úÖ Ready (${db.length} items)`, "success");
                setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 1000);
                
                document.getElementById('appControls').style.display = 'grid';
                populateCompanies();
                renderList(db.slice(0, 50)); // Limit initial render
            }
        });
    }

    // --- 2. UI FUNCTIONS ---
    function populateCompanies() {
        const comps = [...new Set(db.map(i => i.company))].sort();
        const sel = document.getElementById('compSelect');
        sel.innerHTML = '<option value="ALL">-- All Companies --</option>';
        // Fragment for faster DOM insertion
        const frag = document.createDocumentFragment();
        comps.forEach(c => {
            if(c) {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                frag.appendChild(opt);
            }
        });
        sel.appendChild(frag);
    }

    function filterItems() {
        const txt = document.getElementById('search').value.toLowerCase();
        const comp = document.getElementById('compSelect').value;
        
        // Optimized filter
        const filtered = db.filter(i => {
            return (comp === "ALL" || i.company === comp) && 
                   (txt === "" || i.name.toLowerCase().includes(txt));
        });
        
        // Limit render count for performance
        renderList(filtered.slice(0, txt ? 100 : 50));
    }

    function renderList(items) {
        const div = document.getElementById('list');
        div.innerHTML = '';
        if(items.length===0) return div.innerHTML = '<div style="text-align:center; padding:20px;">No items found</div>';

        const frag = document.createDocumentFragment();
        // Render loop
        for(let i=0; i<items.length; i++) {
            const item = items[i];
            const q = cart[item.id] || 0;
            const el = document.createElement('div');
            el.className = 'product-card';
            // Use dataset for event delegation (optional, but clean)
            el.innerHTML = `
                <div class="p-info">
                    <h3>${item.name}</h3>
                    <div class="p-meta">${item.company} ${item.stock ? '| Stock: '+item.stock : ''}</div>
                    <div class="p-price">‚Çπ${item.rate.toFixed(2)}</div>
                </div>
                <div class="qty-box">
                    <button class="q-btn" onclick="upd('${item.id.replace(/'/g, "\\'")}', -1)">-</button>
                    <div class="q-val" id="q_${cleanId(item.id)}">${q}</div>
                    <button class="q-btn" onclick="upd('${item.id.replace(/'/g, "\\'")}', 1)">+</button>
                </div>
            `;
            frag.appendChild(el);
        }
        div.appendChild(frag);
    }

    function cleanId(id) { return id.replace(/[^a-zA-Z0-9]/g, ''); }

    // --- 3. CART & ORDER LOGIC ---
    window.upd = (id, d) => {
        if (!cart[id]) cart[id] = 0;
        cart[id] += d;
        if (cart[id] <= 0) delete cart[id];
        
        // Direct DOM update (Fast)
        const el = document.getElementById('q_' + cleanId(id));
        if (el) el.innerText = cart[id] || 0;
        
        calcTotal();
    };

    function calcTotal() {
        let total = 0, count = 0;
        const keys = Object.keys(cart);
        // Map lookup is O(1)
        for (let i=0; i<keys.length; i++) {
            const id = keys[i];
            const item = dbMap.get(id);
            if (item) { 
                total += item.rate * cart[id]; 
                count++; 
            }
        }
        document.getElementById('cTotal').innerText = total.toFixed(2);
        document.getElementById('cartCount').innerText = count;
        document.getElementById('cartBar').style.display = count > 0 ? 'flex' : 'none';
    }

    window.openOrder = () => {
        document.getElementById('cName').addEventListener('input', updatePrintDetails);
        document.getElementById('cMobile').addEventListener('input', updatePrintDetails);
        renderOrderTable();
        document.getElementById('orderModal').style.display = 'block';
    };

    function updatePrintDetails() {
        const n = document.getElementById('cName').value;
        const m = document.getElementById('cMobile').value;
        document.getElementById('dispName').innerText = n || "(Not Entered)";
        document.getElementById('dispMobile').innerText = m || "(Not Entered)";
    }

    function renderOrderTable() {
        const body = document.getElementById('oBody');
        body.innerHTML = '';
        let subtotal = 0;
        let html = '';

        const keys = Object.keys(cart);
        for (let i=0; i<keys.length; i++) {
            const id = keys[i];
            const item = dbMap.get(id);
            if(item) {
                const val = item.rate * cart[id];
                subtotal += val;
                html += `
                    <tr>
                        <td>${item.name}<br><small>${item.company}</small></td>
                        <td class="text-right">${cart[id]}</td>
                        <td class="text-right">‚Çπ${val.toFixed(2)}</td>
                    </tr>
                `;
            }
        }
        body.innerHTML = html; // Single DOM write

        const gst = subtotal * 0.05;
        const total = subtotal + gst;

        document.getElementById('subTotal').innerText = subtotal.toFixed(2);
        document.getElementById('gstVal').innerText = gst.toFixed(2);
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        document.getElementById('oDate').innerText = new Date().toLocaleString();
    }

    window.printOrder = () => {
        const name = document.getElementById('cName').value;
        if(!name) return alert("Please enter Customer Name first.");
        updatePrintDetails();
        window.print();
    };

    window.shareWA = () => {
        const name = document.getElementById('cName').value;
        const mobile = document.getElementById('cMobile').value;
        if(!name) return alert("Please enter Customer Name first.");

        let text = `*ORDER - AARADHYA PHARMA*\n`;
        text += `üë§ ${name} (${mobile})\n`;
        text += `üìÖ ${new Date().toLocaleDateString()}\n\n`;
        
        const keys = Object.keys(cart);
        for (let i=0; i<keys.length; i++) {
            const id = keys[i];
            const item = dbMap.get(id);
            if(item) text += `${cart[id]} x ${item.name}\n`;
        }

        const grand = document.getElementById('grandTotal').innerText;
        text += `\n*GRAND TOTAL (Inc GST): ‚Çπ${grand}*`;
        text += `\n\n_Designed for AAradhya Pharmaceuticals_`;

        window.open("https://wa.me/?text=" + encodeURIComponent(text));
    };

    init();
</script>
</body>
</html>






































